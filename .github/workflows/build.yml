name: "Build and test"

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string

jobs:

  build:
    runs-on: ${{inputs.os}}
    name: "Build (${{inputs.os}})"
    steps:
      - name: "Checkout source"
        uses: actions/checkout@v1     # >@v1 fails on submodules
        with:
          submodules: true
      - name: "Install build tools (ubuntu)"
        run: sudo apt-get install ninja-build
        if: contains( ${{inputs.os}}, "ubuntu" )
      - name: "Install build tools (mac)"
        run: brew install ninja
        if: contains( ${{inputs.os}}, "mac" )
#     - name: "Build and package"
#       run: NINJA_FLAGS=-v PREFIX= make -j $(nproc) package
      # <DEBUG>
      - run: |
          echo "Build and package"
          mkdir dist
          echo foo > dist/wasi-sdk-$(./version.sh)-linux.tar.gz
          echo bar > dist/libclang_rt.builtins-wasm32-wasi-$(./version.sh).tar.gz
          echo baz > dist/wasi-sysroot-$(./version.sh).tar.gz
      # </DEBUG>
      - name: "Upload build artifacts"
        uses: actions/upload-artifact@v3
        with:
          path: dist
          name: ${{ format('dist-{0}', inputs.os) }}

  test:
    runs-on: ${{inputs.os}}
    name: "Test ${{inputs.os}}"
    needs: build
    steps:
      - name: "Checkout source"
        uses: actions/checkout@v1
        with:
          submodules: false           # Not required for tests
      - name: "Download build artifacts"
        uses: actions/download-artifact@v3
        with:
          name: ${{ format('dist-{0}', inputs.os) }}
          path: dist
      - name: "Extract build artifacts"
        run: tar -xvzf dist/wasi-sdk-*.tar.gz
      - name: "Install build artifacts"
        run: >-
          mkdir build
          && mv wasi-sdk-* build/install
#     - name: "Run test suite"
#       run: NINJA_FLAGS=-v PREFIX= make -j $(nproc) check
      # <DEBUG>
      - run: |
          echo "Run test suite"
      # </DEBUG>

