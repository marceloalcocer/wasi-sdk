name: "Build, test, release"

on:
  push:
    tags:
      - "wasi-sdk-*"
    branches:
#     - main
      # <DEBUG>
      - dev
      # </DEBUG>
  pull_request:

jobs:

  build:
    name: "Build and test"
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
      fail-fast: false
    runs-on: ${{matrix.os}}
    uses: ./.github/workflows/build
    with:
      os: ${{matrix.os}}

  release:
    name: "Release"
    runs-on: ubuntu-latest
    needs: build
    if: >-
      contains(github.event_name, 'push')
      && contains(github.event.ref, 'refs/tags')
    steps:
      - name: "Download build artifacts"
        uses: actions/download-artifact@v3
        with:
          name: ${{ format('dist-{0}', runner.os) }}
          path: dist
      - name: "Rename build artifacts"
        run: for file in dist/*.tar.gz; do mv $file ${file/.tar.gz/_${{runner.os}}_${{runner.arch}}.tar.gz}; done
      - name: "Create release"
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: dist/*.tar.gz

